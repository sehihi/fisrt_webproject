<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Graph Visualization</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      h1 {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }
      #myPieChart {
        display: flex;
        width: 50%;
        height: 50%;
      }
      #detailPieChart {
        display: flex;
        width: 50%;
        height: 50%;
      }
      #detailChart {
        display: flex;
        width: 50%;
        height: 50%;
      }
    </style>
  </head>
  <body>
    <h1>사유코드 설명 파이 차트</h1>
    <canvas id="myPieChart"></canvas>
    <canvas id="detailPieChart" style="display: none"></canvas>
    <canvas id="detailChart" style="display: none"></canvas>
    <!-- 상세 차트는 처음엔 숨김 -->

    <script>
      let myPieChart;
      let detailPieChart;
      let detailChart;

      // /status-data API로부터 데이터 가져오기
      fetch("/status-data2")
        .then((response) => response.json())
        .then((data) => {
          const ctx = document.getElementById("myPieChart").getContext("2d");

          const chartData = {
            labels: ["정상", "불량"],
            datasets: [
              {
                data: [data.정상, data.불량],
                backgroundColor: ["#36A2EB", "#FF6384"],
                hoverBackgroundColor: ["#36A2EB", "#FF6384"],
              },
            ],
          };

          myPieChart = new Chart(ctx, {
            type: "pie",
            data: chartData,
            options: {
              responsive: false,
              onClick: (evt, activeElements) => {
                if (activeElements.length > 0) {
                  const datasetIndex = activeElements[0].datasetIndex;
                  const index = activeElements[0].index;
                  const label = myPieChart.data.labels[index];

                  if (label === "불량") {
                    // 불량 항목을 클릭했을 때 상세 사유 데이터 가져오기
                    fetch("/fault-details")
                      .then((response) => response.json())
                      .then((detailData) => {
                        const detailCtx = document
                          .getElementById("detailPieChart")
                          .getContext("2d");
                        const labels = detailData.map(
                          (item) => item["사유코드설명"]
                        );
                        const counts = detailData.map((item) => item.count);

                        // 기존 차트가 있으면 삭제
                        if (detailPieChart) detailPieChart.destroy();

                        // 상세 차트 생성
                        detailPieChart = new Chart(detailCtx, {
                          type: "pie",
                          data: {
                            labels: labels,
                            datasets: [
                              {
                                data: counts,
                                backgroundColor: [
                                  "#FF9F40",
                                  "#FF6384",
                                  "#36A2EB",
                                  "#4BC0C0",
                                  "#4BC0FF",
                                ],
                              },
                            ],
                          },
                          options: {
                            responsive: false,
                            onClick: (evt, ActiveElements) => {
                              if (ActiveElements.length > 0) {
                                const index = ActiveElements[0].index;
                                const clickedLabel =
                                  detailPieChart.data.labels[index];

                                // 선택한 사유코드 설명에 따른 선종 데이터를 로드
                                loadDetailChart(clickedLabel);
                              }
                            },
                          },
                        });

                        // 상세 차트를 보여줌
                        document.getElementById(
                          "detailPieChart"
                        ).style.display = "block";
                      });
                  }
                }
              },
            },
          });
        });
      // 선택한 사유코드 설명에 따른 선종 데이터를 가져와서 막대그래프로 출력
      function loadDetailChart(reasonCode) {
        fetch(`/detail-data/${reasonCode}`)
          .then((response) => response.json())
          .then((detailData) => {
            const detailCtx = document
              .getElementById("detailChart")
              .getContext("2d");
            const detailLabels = detailData.map((item) => item["선종"]); // 선종 데이터
            const detailCounts = detailData.map((item) => item.count); // 선종별 count

            if (detailChart) {
              detailChart.destroy(); // 기존 차트가 있으면 제거
            }

            detailChart = new Chart(detailCtx, {
              type: "bar",
              data: {
                labels: detailLabels,
                datasets: [
                  {
                    data: detailCounts,
                    backgroundColor: ["#FF6384", "#36A2EB", "#FFCE56"],
                  },
                ],
              },
              options: {
                responsive: false,
              },
            });

            // 상세 차트를 화면에 표시
            document.getElementById("detailChart").style.display = "block";
          });
      }
    </script>
  </body>
</html>
